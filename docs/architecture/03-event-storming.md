# âš¡ ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆãƒ¼ãƒŸãƒ³ã‚°

## 1. ãƒ“ãƒƒã‚°ãƒ”ã‚¯ãƒãƒ£ãƒ¼

```
æ™‚é–“è»¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User   â”‚   â”‚  User   â”‚   â”‚ System  â”‚   â”‚  Agent  â”‚   â”‚  User   â”‚
â”‚ signed  â”‚â”€â”€â–ºâ”‚ started â”‚â”€â”€â–ºâ”‚ created â”‚â”€â”€â–ºâ”‚ invoked â”‚â”€â”€â–ºâ”‚received â”‚
â”‚   in    â”‚   â”‚  chat   â”‚   â”‚ session â”‚   â”‚         â”‚   â”‚response â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    ğŸŸ§            ğŸŸ§            ğŸŸ§            ğŸŸ§            ğŸŸ§
                     â”‚              â”‚              â”‚
                     â–¼              â–¼              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Session  â”‚  â”‚  Message  â”‚  â”‚  Agent    â”‚
              â”‚  Created  â”‚  â”‚   Added   â”‚  â”‚ Responded â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   ğŸŸ¨             ğŸŸ¨             ğŸŸ¨
```

**å‡¡ä¾‹**:
- ğŸŸ§ ã‚³ãƒãƒ³ãƒ‰ (Command)
- ğŸŸ¨ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ (Domain Event)
- ğŸŸ¦ é›†ç´„ (Aggregate)
- ğŸŸ© èª­ã¿å–ã‚Šãƒ¢ãƒ‡ãƒ« (Read Model)
- ğŸŸª ãƒãƒªã‚·ãƒ¼ (Policy)

## 2. ãƒ—ãƒ­ã‚»ã‚¹ãƒ¢ãƒ‡ãƒªãƒ³ã‚°

### 2.1 ãƒãƒ£ãƒƒãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Chat Session Start Flow                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[User]                                              [System]
   â”‚                                                    â”‚
   â”‚  â‘  StartChat                                       â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º                â”‚
   â”‚  ğŸŸ§                                                â”‚
   â”‚                                                    â”‚
   â”‚                         â‘¡ SessionCreated          â”‚
   â”‚                         ğŸŸ¨                         â”‚
   â”‚                              â”‚                     â”‚
   â”‚                              â–¼                     â”‚
   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                    â”‚   ChatSession   â”‚            â”‚
   â”‚                    â”‚     ğŸŸ¦          â”‚            â”‚
   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                              â”‚                     â”‚
   â”‚                              â–¼                     â”‚
   â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
   â”‚                    â”‚ SessionListView â”‚            â”‚
   â”‚                    â”‚     ğŸŸ©          â”‚            â”‚
   â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
   â”‚                                                    â”‚
   â”‚  â‘¢ Session Info                                   â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
```

### 2.2 ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Message Send Flow                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[User]              [Chat Context]           [Agent Context]
   â”‚                      â”‚                        â”‚
   â”‚  â‘  SendMessage       â”‚                        â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚                        â”‚
   â”‚  ğŸŸ§                   â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚               â‘¡ MessageAdded                  â”‚
   â”‚               ğŸŸ¨      â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚  â‘¢ InvokeAgent        â”‚
   â”‚                      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚
   â”‚                      â”‚  ğŸŸª Policy             â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚                 â‘£ AgentInvoked
   â”‚                      â”‚                 ğŸŸ¨      â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚                 [Tool calls...]
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚                 â‘¤ AgentCompleted
   â”‚                      â”‚                 ğŸŸ¨      â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚  â‘¥ AddAssistantMsg    â”‚
   â”‚                      â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
   â”‚                      â”‚  ğŸŸª Policy             â”‚
   â”‚                      â”‚                        â”‚
   â”‚               â‘¦ MessageAdded                  â”‚
   â”‚               ğŸŸ¨      â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚  â‘§ Response          â”‚                        â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚                        â”‚
```

### 2.3 ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     File Upload Flow                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[User]              [File Context]           [Agent Context]
   â”‚                      â”‚                        â”‚
   â”‚  â‘  GetUploadUrl      â”‚                        â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚                        â”‚
   â”‚  ğŸŸ§                   â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚  â‘¡ Presigned URL     â”‚                        â”‚
   â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚  â‘¢ Upload to S3      â”‚                        â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚                        â”‚
   â”‚  (Direct)            â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚  â‘£ RegisterFile      â”‚                        â”‚
   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚                        â”‚
   â”‚  ğŸŸ§                   â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚               â‘¤ FileUploaded                  â”‚
   â”‚               ğŸŸ¨      â”‚                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚               â‘¥ ProcessFile                   â”‚
   â”‚               â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º      â”‚
   â”‚               ğŸŸª Policy                        â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚                 â‘¦ FileProcessed
   â”‚                      â”‚                 ğŸŸ¨      â”‚
   â”‚                      â”‚                        â”‚
   â”‚                      â”‚  â‘§ UpdateMetadata     â”‚
   â”‚                      â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
   â”‚                      â”‚  ğŸŸª Policy             â”‚
```

## 3. ã‚³ãƒãƒ³ãƒ‰ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼ä¸€è¦§

### 3.1 Chat Context

| ã‚³ãƒãƒ³ãƒ‰ | é›†ç´„ | ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒªã‚·ãƒ¼ |
|----------|------|----------|----------|
| StartChat | ChatSession | SessionCreated | - |
| SendMessage | ChatSession | MessageAdded | InvokeAgentOnUserMessage |
| ArchiveSession | ChatSession | SessionArchived | - |

### 3.2 Agent Context

| ã‚³ãƒãƒ³ãƒ‰ | é›†ç´„ | ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒªã‚·ãƒ¼ |
|----------|------|----------|----------|
| InvokeAgent | AgentInvocation | AgentInvoked | - |
| CallTool | AgentInvocation | ToolCalled | - |
| CompleteAgent | AgentInvocation | AgentCompleted | AddAssistantMessage |
| FailAgent | AgentInvocation | AgentFailed | NotifyError |

### 3.3 File Context

| ã‚³ãƒãƒ³ãƒ‰ | é›†ç´„ | ã‚¤ãƒ™ãƒ³ãƒˆ | ãƒãƒªã‚·ãƒ¼ |
|----------|------|----------|----------|
| GetUploadUrl | - | - | - |
| RegisterFile | UploadedFile | FileUploaded | ProcessFileOnUpload |
| ProcessFile | UploadedFile | FileProcessed | UpdateFileMetadata |
| DeleteFile | UploadedFile | FileDeleted | RemoveFromS3 |

## 4. èª­ã¿å–ã‚Šãƒ¢ãƒ‡ãƒ«

### 4.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãƒ“ãƒ¥ãƒ¼

```typescript
interface SessionListView {
  sessionId: string;
  title: string;
  lastMessageAt: Date;
  messageCount: number;
  status: 'active' | 'archived';
}

// æŠ•å½±ãƒ­ã‚¸ãƒƒã‚¯
class SessionListProjector {
  on(event: SessionCreated): void {
    this.repository.insert({
      sessionId: event.sessionId,
      title: event.title,
      lastMessageAt: event.occurredAt,
      messageCount: 0,
      status: 'active',
    });
  }

  on(event: MessageAdded): void {
    this.repository.update(event.sessionId, {
      lastMessageAt: event.timestamp,
      messageCount: { $inc: 1 },
    });
  }

  on(event: SessionArchived): void {
    this.repository.update(event.sessionId, {
      status: 'archived',
    });
  }
}
```

### 4.2 ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ“ãƒ¥ãƒ¼

```typescript
interface ChatHistoryView {
  sessionId: string;
  messages: Array<{
    messageId: string;
    role: 'user' | 'assistant' | 'system';
    content: string;
    timestamp: Date;
    files?: Array<{
      fileId: string;
      fileName: string;
      fileType: string;
    }>;
  }>;
}
```

## 5. ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ãƒˆã‚¢è¨­è¨ˆ

### 5.1 DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆ

```
EventStore Table:
  PK: aggregateId (e.g., "session#123")
  SK: version (e.g., 1, 2, 3...)
  
  Attributes:
    - eventType: string
    - payload: JSON
    - metadata: JSON
    - occurredAt: ISO8601
    - causationId: string (optional)
    - correlationId: string (optional)

GSI1 (EventType Index):
  PK: eventType
  SK: occurredAt
  
GSI2 (Correlation Index):
  PK: correlationId
  SK: occurredAt
```

### 5.2 ã‚¤ãƒ™ãƒ³ãƒˆæ°¸ç¶šåŒ–

```typescript
interface StoredEvent {
  aggregateId: string;
  version: number;
  eventType: string;
  payload: Record<string, unknown>;
  metadata: {
    userId: string;
    timestamp: string;
    causationId?: string;
    correlationId?: string;
  };
}
```
